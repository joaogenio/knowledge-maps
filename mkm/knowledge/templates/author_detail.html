{% extends "base.html" %}

{% block title %}<title>{{ author.name }} - Knowledge App</title>{% endblock %}
{% load static %}

{% block content %}

<!-- Content Wrapper. Contains page content -->
<div class="content-wrapper" style="min-height: 823px;">
    <!-- Content Header (Page header) -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">{{ author.name }}</h1>
                </div><!-- /.col -->
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="#">Home</a></li>
                        <li class="breadcrumb-item active">Dashboard v1</li>
                    </ol>
                </div><!-- /.col -->
            </div><!-- /.row -->
        </div><!-- /.container-fluid -->
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <section class="content">
        
        <div class="container-fluid">

            <!-- Main row -->
            <div class="row">
                <!-- Left col -->
                <section class="col-lg-6 connectedSortable ui-sortable">

                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title">
                                Collaboration map{% if search_keywords %}, related with "<b>{{ search_keyword }}</b>"{% endif %},
                                from {{ map_publication_start }} to {{ map_publication_end }}
                            </h3>
                        </div>
                        <!-- /.card-header -->

                        <div id="map" class="card-body p-0">
                            <div id="mynetwork"></div>
                        </div>
                        <!-- /.card-body -->

                        <div class="card-footer bg-info">
                            
                            <div class="btn-group">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-info" onclick="draw()">
                                        Re-draw
                                    </button>
                                </div>

                                <!--<div class="btn-group">
                                    <button type="button" class="disabled btn btn-info" onclick="draw()">
                                        Save seed
                                    </button>
                                </div>-->

                                <div class="btn-group">
                                    <button type="button" class="btn btn-info dropdown-toggle dropdown-icon" data-toggle="dropdown">
                                        Keywords &nbsp
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-keywords">

                                        <form method="post">
                                            {% csrf_token %}
                                            <div class="input-group input-group-sm" style="padding: 7px 14px 7px">
                                                
                                                <input type="text" name="keyword-search" class="form-control" placeholder="Search keywords">
                                                <div class="input-group-append">
                                                    <button type="submit" class="btn btn-default">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>

                                        <form method="post" style="padding: 7px 0px 0px;">
                                            {% csrf_token %}
                                            <input class="btn btn-info btn-flat {% if search_keywords %}{% else %}disabled{% endif %}" name="reset-keyword" type="submit" value="Reset keywords" style="width: 100%;">
                                        </form>

                                        <form method="post" style="padding: 14px 0px 0px;">
                                            {% csrf_token %}
                                            <div style="padding: 0px 0px 14px;">
                                                <input class="btn btn-info btn-flat {% if search_keywords %}{% else %}disabled{% endif %}" name="keyword-update" type="submit" value="Update keywords" style="width: 100%;">
                                            </div>
                                            {% if search_keywords %}
                                                {% for i in search_keywords %}
                                                    <div class="form-check" style="padding: 0px 40px 0px">
                                                        <input class="form-check-input bg-info" type="checkbox" {% if i.1 %}checked="" {% endif %}name="{{ forloop.counter0 }}" value="{{ i.1 }}">
                                                        <label class="form-check-label">{{ i.0 }}</label>
                                                    </div>
                                                    
                                                    <!--<form method="post">
                                                        {% csrf_token %}
                                                        <input class="
                                                            {% if i == selected_keyword %} selected {% endif %}
                                                        " name="keyword" type="submit" value="{{ i }}">
                                                    </form>-->
                                                {% endfor %}
                                            {% endif %}
                                        </form>
                                        

                                    </div>
                                </div>

                                <div class="btn-group">
                                    <button type="button" class="btn btn-info dropdown-toggle dropdown-icon" data-toggle="dropdown">
                                        Start year &nbsp
                                    </button>
                                    <div class="dropdown-menu">
                                        {% for i in map_start_range %}
                                            <form method="post">
                                                {% csrf_token %}
                                                <input class="chartinput
                                                    {% if i == map_publication_start %} selected {% endif %}
                                                " name="map_publication_start" type="submit" value="{{ i }}">
                                            </form>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="btn-group">
                                    <button type="button" class="btn btn-info dropdown-toggle dropdown-icon" data-toggle="dropdown">
                                        End year &nbsp
                                    </button>
                                    <div class="dropdown-menu">
                                        {% for i in map_end_range %}
                                            <form method="post">
                                                {% csrf_token %}
                                                <input class="chartinput
                                                    {% if i == map_publication_end %} selected {% endif %}
                                                " name="map_publication_end" type="submit" value="{{ i }}">
                                            </form>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            

                        </div>
                        <!-- /.card-footer -->
                    </div>

                </section>
                <!-- /.Left col -->

                <!-- right col (We are only adding the ID to make the widgets sortable)-->
                <section class="col-lg-6 connectedSortable ui-sortable">

                    <div class="card card-warning">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="viewer_title" id="viewer" hidden>Viewer</span>
                                {% for key, author in nodes_authors.items %}
                                    <span class="viewer_title" id="viewer-{{ key }}" hidden>
                                        {{ author.publications|length }}
                                        <b>
                                            {% if map_publication_type == 'All' %}
                                                Publication{% if author.publications|length != 1 %}s{% endif %}
                                            {% elif map_publication_type == 'Other' %}
                                                Other Publication{% if author.publications|length != 1 %}s{% endif %}
                                            {% else %}
                                                {% if author.publications|length == 1 %} {{ map_publication_type }}
                                                {% else %} {{ map_publication_type }}s {% endif %}
                                            {% endif %}
                                        </b>
                                        from
                                        <a href="/authors/{{ key }}"><u>{{ author.name }}</u></a>
                                    </span>
                                {% endfor %}
                                {% for key, value in edges_publications.items %}
                                    <span class="viewer_title" id="viewer-{{ key }}" hidden>
                                        {{ value.publications|length }}
                                        <b>
                                            {% if map_publication_type == 'All' %}
                                                Publication{% if value.publications|length != 1 %}s{% endif %}
                                            {% elif map_publication_type == 'Other' %}
                                                Other Publication{% if value.publications|length != 1 %}s{% endif %}
                                            {% else %}
                                                {% if value.publications|length == 1 %} {{ map_publication_type }}
                                                {% else %} {{ map_publication_type }}s {% endif %}
                                            {% endif %}
                                        </b>
                                        between
                                        <a href="/authors/{{ value.author_1.id }}"><u>{{ value.author_1.short_name }}</u></a>
                                        and
                                        <a href="/authors/{{ value.author_2.id }}"><u>{{ value.author_2.short_name }}</u></a>
                                    </span>
                                {% endfor %}
                            </h3>
                            <div class="card-tools">
                                
                            </div>
                        </div>
                        <!-- /.card-header -->

                        <div id="viewer" class="card-body p-0 table-responsive">

                            <span id="eventSpanContent" hidden></span>

                            {% for key, author in nodes_authors.items %}

                                <span class="viewer_author" id="{{ key }}" hidden>

                                    <table class="table table-head-fixed table-hover table-sm">
                                        <thead>
                                            <tr>
                                                <th class="centered">#</th>
                                                <th class="centered" colspan="2">APIs</th>
                                                <th class="centered">Publication&nbsptype</th>
                                                <th class="centered">Authors</th>
                                                <th class="centered">Keywords</th>
                                                <th class="centered">Areas</th>
                                                <th class="centered">Abstract</th>
                                                <th class="centered">Full&nbsptext</th>
                                                <th class="centered">Date</th>
                                                <th class="centered">Title</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for publication in author.publications %}
                                            <tr>
                                                <td class="centered bold">
                                                    <p
                                                        class="inline">
                                                        {{ forloop.counter }}
                                                    </p>
                                                </td>
                                                <td class="centered red bold">
                                                    <p
                                                        class="inline">
                                                        {% if publication.from_scopus %}
                                                            <span class="badge bg-danger">SC</span>
                                                        {% endif %}
                                                    </p>
                                                </td>
                                                <td class="centered green bold">
                                                    <p
                                                        class="inline">
                                                        {% if publication.from_ciencia %}
                                                        <span class="badge bg-success">CV</span>
                                                        {% endif %}
                                                    </p>
                                                </td>
                                                <!--<td class="">
                                                    <p
                                                        class="inline">
                                                        {{publication.id}}
                                                    </p>
                                                </td>-->
                                                <td class="centered">
                                                    <p
                                                        class="inline">
                                                        {{publication.publication_type.name}}
                                                    </p>
                                                </td>

                                                <td class="centered bold">
                                                    <p
                                                        title="{% for author in publication.author_set %}{{author.name}}     {% endfor %}"
                                                        class="inline">
                                                        {{publication.author_set|length}}
                                                    </p>
                                                </td>
                                                {% if publication.author_set|length != 1 %}
                                                    
                                                {% else %}
                                                    <!--<td></td>-->
                                                {% endif %}

                                                {% if publication.keywords|length != 0 %}
                                                    <td class="centered bold">
                                                        <p
                                                            title="{% for keyword in publication.keywords %}{{keyword}}     {% endfor %}"
                                                            class="inline">
                                                            {{publication.keywords|length}}
                                                        </p>
                                                    </td>
                                                {% else %}
                                                    <td></td>
                                                {% endif %}
                                                {% if publication.areas|length != 0 %}
                                                    <td class="centered bold">
                                                        <p
                                                            title="{% for area in publication.areas %}{{area.name}}     {% endfor %}"
                                                            class="inline">
                                                            {{publication.areas|length}}
                                                        </p>
                                                    </td>
                                                {% else %}
                                                    <td></td>
                                                {% endif %}
                                                {% if publication.abstract != "" %}
                                                    <td class="centered bold">
                                                        <p
                                                            title="{{publication.abstract}}"
                                                            class="inline">
                                                            <span class="badge bg-success">✓</span>
                                                        </p>
                                                    </td>
                                                {% else %}
                                                    <td></td>
                                                {% endif %}
                                                {% if publication.available %}
                                                    <td class="centered bold">
                                                        <p
                                                            class="inline">
                                                            <span class="badge bg-success">✓</span>
                                                        </p>
                                                    </td>
                                                {% else %}
                                                    <td></td>
                                                {% endif %}
                                                <td><p class="centered inline">{{publication.date}}</p></td>
                                                <td class="centered bold">
                                                    <p title="{{publication.scopus_id}}  --  {{publication.ciencia_id}} -- {{publication.doi}}">
                                                        {{publication.title}}
                                                    </p>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </span>

                            {% endfor %}

                            {% for key, value in edges_publications.items %}
                                <span class="viewer_publications" id="{{ key }}" hidden>
                                    <table class="table table-head-fixed table-hover table-sm">
                                        <thead>
                                            <tr>
                                                <th class="centered">#</th>
                                                <th class="centered" colspan="2">APIs</th>
                                                <th class="centered">Publication&nbsptype</th>
                                                <th class="centered">Authors</th>
                                                <th class="centered">Keywords</th>
                                                <th class="centered">Areas</th>
                                                <th class="centered">Abstract</th>
                                                <th class="centered">Full&nbsptext</th>
                                                <th class="centered">Date</th>
                                                <th class="centered">Title</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for publication in value.publications %}
                                            <tr>
                                                <td class="centered bold">
                                                    <p
                                                        class="inline">
                                                        {{ forloop.counter }}
                                                    </p>
                                                </td>
                                                <td class="centered red bold">
                                                    <p
                                                        class="inline">
                                                        {% if publication.from_scopus %}
                                                            <span class="badge bg-danger">SC</span>
                                                        {% endif %}
                                                    </p>
                                                </td>
                                                <td class="centered green bold">
                                                    <p
                                                        class="inline">
                                                        {% if publication.from_ciencia %}
                                                        <span class="badge bg-success">CV</span>
                                                        {% endif %}
                                                    </p>
                                                </td>
                                                <!--<td class="">
                                                    <p
                                                        class="inline">
                                                        {{publication.id}}
                                                    </p>
                                                </td>-->
                                                <td class="centered">
                                                    <p
                                                        class="inline">
                                                        {{publication.publication_type.name}}
                                                    </p>
                                                </td>

                                                <td class="centered bold">
                                                    <p
                                                        title="{% for author in publication.author_set %}{{author.name}}     {% endfor %}"
                                                        class="inline">
                                                        {{publication.author_set|length}}
                                                    </p>
                                                </td>
                                                {% if publication.author_set|length != 1 %}
                                                    
                                                {% else %}
                                                    <!--<td></td>-->
                                                {% endif %}

                                                {% if publication.keywords|length != 0 %}
                                                    <td class="centered bold">
                                                        <p
                                                            title="{% for keyword in publication.keywords %}{{keyword}}     {% endfor %}"
                                                            class="inline">
                                                            {{publication.keywords|length}}
                                                        </p>
                                                    </td>
                                                {% else %}
                                                    <td></td>
                                                {% endif %}
                                                {% if publication.areas|length != 0 %}
                                                    <td class="centered bold">
                                                        <p
                                                            title="{% for area in publication.areas %}{{area.name}}     {% endfor %}"
                                                            class="inline">
                                                            {{publication.areas|length}}
                                                        </p>
                                                    </td>
                                                {% else %}
                                                    <td></td>
                                                {% endif %}
                                                {% if publication.abstract != "" %}
                                                    <td class="centered bold">
                                                        <p
                                                            title="{{publication.abstract}}"
                                                            class="inline">
                                                            <span class="badge bg-success">✓</span>
                                                        </p>
                                                    </td>
                                                {% else %}
                                                    <td></td>
                                                {% endif %}
                                                {% if publication.available %}
                                                    <td class="centered bold">
                                                        <p
                                                            class="inline">
                                                            <span class="badge bg-success">✓</span>
                                                        </p>
                                                    </td>
                                                {% else %}
                                                    <td></td>
                                                {% endif %}
                                                <td><p class="centered inline">{{publication.date}}</p></td>
                                                <td class="centered bold">
                                                    <p title="{{publication.scopus_id}}  --  {{publication.ciencia_id}} -- {{publication.doi}}">
                                                        {{publication.title}}
                                                    </p>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    <br>
                                </span>
                            {% endfor %}

                        </div>
                        <!-- /.card-body -->

                        <div class="card-footer bg-warning">

                            <div class="btn-group">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-warning dropdown-toggle dropdown-icon" data-toggle="dropdown">
                                        Publication type &nbsp
                                    </button>
                                    <div class="dropdown-menu">

                                        {% for pub_type in publication_types %}
                                            <form method="post">
                                                {% csrf_token %}
                                                <input class="chartinput
                                                    {% if pub_type == map_publication_type %} selected {% endif %}
                                                " name="map_publication_type" type="submit" value="{{ pub_type }}">
                                            </form>
                                        {% endfor %}

                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>
                    <!-- /.card -->

                </section>
                <!-- right col -->

            </div>
            <!-- /.row (main row) -->

            <!-- Small boxes (Stat box) -->
            <div class="row">
                <div class="col-lg-3 col-6">
                    <!-- small box -->
                    <div class="small-box bg-info">
                        <div class="inner">
                            <h3>{{ publications.count }}</h3>

                            <p>Publications</p>
                        </div>
                        <div class="icon">
                            <i class="ion ion-document-text"></i>
                        </div>
                        <!--<a href="#" class="small-box-footer">More info <i
                                class="fas fa-arrow-circle-right"></i></a>-->
                    </div>
                </div>
                <!-- ./col -->
                <div class="col-lg-3 col-6">
                    <!-- small box -->
                    <div class="small-box bg-success">
                        <div class="inner">
                            <h3>{{ projects.count }}</h3>

                            <p>Projects</p>
                        </div>
                        <div class="icon">
                            <i class="ion ion-edit"></i>
                        </div>
                        <!--<a href="#" class="small-box-footer">More info <i
                                class="fas fa-arrow-circle-right"></i></a>-->
                    </div>
                </div>
                <!-- ./col -->
                <div class="col-lg-3 col-6">
                    <!-- small box -->
                    <div class="small-box bg-warning">
                        <div class="inner">
                            <h3>{{ sorted_author_keywords|length }}</h3>

                            <p>Keywords</p>
                        </div>
                        <div class="icon">
                            <i class="ion ion-lightbulb"></i>
                        </div>
                        <!--<a href="#" class="small-box-footer">More info <i
                                class="fas fa-arrow-circle-right"></i></a>-->
                    </div>
                </div>
                <!-- ./col -->
                <div class="col-lg-3 col-6">
                    <!-- small box -->
                    <div class="small-box bg-danger">
                        <div class="inner">
                            <h3>{{ sorted_author_areas|length }}</h3>

                            <p>Areas</p>
                        </div>
                        <div class="icon">
                            <i class="ion ion-university"></i>
                        </div>
                        <!--<a href="#" class="small-box-footer">More info <i
                                class="fas fa-arrow-circle-right"></i></a>-->
                    </div>
                </div>
                <!-- ./col -->
            </div>
            <!-- /.row -->

            <!-- Main row -->
            <div class="row">
                <!-- Left col -->
                <section class="col-lg-7 connectedSortable ui-sortable">


                    <!-- BAR CHART -->
                    <div class="card card-info">
                        <div class="card-header">
                            <h3 class="card-title">
                                {{ total_data_publications }}
                                <span class="bold">
                                {% if publication_type == 'All' %}
                                    Publications
                                {% elif publication_type == 'Other' %}
                                    Other Publications
                                {% else %}
                                    {{ publication_type }}s
                                {% endif %}
                                </span>
                                between {{ publication_start }} and {{ publication_end }}
                            </h3>

                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button type="button" class="btn btn-tool" data-card-widget="remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="card-body">
                            <div class="chart">
                                <canvas id="barChart_publications"
                                    style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                            </div>
                        </div>
                        <!-- /.card-body -->

                        <div class="card-footer bg-info">
                            
                            <div class="btn-group">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-info dropdown-toggle dropdown-icon" data-toggle="dropdown">
                                        Publication type &nbsp
                                    </button>
                                    <div class="dropdown-menu">

                                        {% for pub_type in publication_types %}
                                            <form method="post">
                                                {% csrf_token %}
                                                <input class="chartinput
                                                    {% if pub_type == publication_type %} selected {% endif %}
                                                " name="publication-type" type="submit" value="{{ pub_type }}">
                                            </form>
                                        {% endfor %}

                                    </div>
                                </div>

                                <div class="btn-group">
                                    <button type="button" class="btn btn-info dropdown-toggle dropdown-icon" data-toggle="dropdown">
                                        Start year &nbsp
                                    </button>
                                    <div class="dropdown-menu">
                                        {% for i in publication_start_range %}
                                            <form method="post">
                                                {% csrf_token %}
                                                <input class="chartinput
                                                    {% if i == publication_start %} selected {% endif %}
                                                " name="publication-start" type="submit" value="{{ i }}">
                                            </form>
                                        {% endfor %}
                                    </div>
                                </div>

                                <div class="btn-group">
                                    <button type="button" class="btn btn-info dropdown-toggle dropdown-icon" data-toggle="dropdown">
                                        End year &nbsp
                                    </button>
                                    <div class="dropdown-menu">
                                        {% for i in publication_end_range %}
                                            <form method="post">
                                                {% csrf_token %}
                                                <input class="chartinput
                                                    {% if i == publication_end %} selected {% endif %}
                                                " name="publication-end" type="submit" value="{{ i }}">
                                            </form>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            

                        </div>
                        <!-- /.card-footer -->
                    </div>
                    <!-- /.card -->

                    <!-- BAR CHART -->
                    <div class="card card-success">
                        <div class="card-header">
                            <h3 class="card-title">{{ total_data_projects }} <span class="bold">Projects</span> between {{ project_start }} and {{ project_end }}</h3>

                            <div class="card-tools">
                                <button type="button" class="btn btn-tool" data-card-widget="collapse">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button type="button" class="btn btn-tool" data-card-widget="remove">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart">
                                <canvas id="barChart_projects"
                                    style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                            </div>
                        </div>
                        <!-- /.card-body -->

                        <div class="card-footer bg-success">
                            
                            
                            <div class="btn-group">

                                <div class="btn-group">
                                    <button type="button" class="btn btn-success dropdown-toggle dropdown-icon" data-toggle="dropdown">
                                        Start year &nbsp
                                    </button>
                                    <div class="dropdown-menu">

                                        {% for i in project_start_range %}
                                            <form method="post">
                                                {% csrf_token %}
                                                <input class="chartinput
                                                    {% if i == project_start %} selected {% endif %}
                                                " name="project-start" type="submit" value="{{ i }}">
                                            </form>
                                        {% endfor %}

                                    </div>
                                </div>

                                <div class="btn-group">
                                    <button type="button" class="btn btn-success dropdown-toggle dropdown-icon" data-toggle="dropdown">
                                        End year &nbsp
                                    </button>
                                    <div class="dropdown-menu">
                                    
                                        {% for i in project_end_range %}
                                            <form method="post">
                                                {% csrf_token %}
                                                <input class="chartinput
                                                    {% if i == project_end %} selected {% endif %}
                                                " name="project-end" type="submit" value="{{ i }}">
                                            </form>
                                        {% endfor %}

                                    </div>
                                </div>
                            </div>

                        </div>
                        <!-- /.card-footer -->
                    </div>
                    <!-- /.card -->

                    <div class="card card-gray">
                        <div class="card-header">
                            <h3 class="card-title">Top collaborators</h3>
                        </div>
                        <!-- /.card-header -->
                        <div class="card-body p-0">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th style="width: 10px">#</th>
                                        <th>Name</th>
                                        <th>From publications</th>
                                        <th>From projects</th>
                                    </tr>
                                </thead>
                                <tbody>

                                    {% for author, cnt in sorted_collaborators.items %}

                                        {% if forloop.counter <= 5 %}

                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>
                                                    <a href="{% url 'author_detail' author.pk %}">{{ author.name }}</a>
                                                </td>
                                                <td>
                                                    {{ cnt.0 }}
                                                </td>
                                                <td>
                                                    {{ cnt.1 }}
                                                </td>
                                            </tr>

                                        {% endif %}

                                    {% endfor %}
                                    
                                </tbody>
                            </table>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->


                </section>
                <!-- /.Left col -->
                <!-- right col (We are only adding the ID to make the widgets sortable)-->
                <section class="col-lg-5 connectedSortable ui-sortable">


                    <div class="card card-warning">
                        <div class="card-header">
                            <h3 class="card-title">Most common keywords</h3>
                        </div>
                        <!-- /.card-header -->
                        <div class="card-body p-0">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th style="width: 10px">#</th>
                                        <th>Keyword</th>
                                        <th>Count</th>
                                    </tr>
                                </thead>
                                <tbody>

                                    {% for name, cnt in sorted_author_keywords.items %}

                                        {% if forloop.counter <= 10 %}

                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>
                                                    {{ name }}
                                                </td>
                                                <td>
                                                    {{ cnt }}
                                                </td>
                                            </tr>

                                        {% endif %}

                                    {% endfor %}
                                    
                                </tbody>
                            </table>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->

                    <div class="card card-danger">
                        <div class="card-header">
                            <h3 class="card-title">Most common areas</h3>
                        </div>
                        <!-- /.card-header -->
                        <div class="card-body p-0">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th style="width: 10px">#</th>
                                        <th>Area</th>
                                        <th>From publications</th>
                                        <th>From projects</th>
                                    </tr>
                                </thead>
                                <tbody>

                                    {% for name, cnt in sorted_author_areas.items %}

                                        {% if forloop.counter <= 10 %}

                                            <tr>
                                                <td>{{ forloop.counter }}</td>
                                                <td>
                                                    {{ name }}
                                                </td>
                                                <td>
                                                    {{ cnt.0 }}
                                                </td>
                                                <td>
                                                    {{ cnt.1 }}
                                                </td>
                                            </tr>

                                        {% endif %}

                                    {% endfor %}
                                    
                                </tbody>
                            </table>
                        </div>
                        <!-- /.card-body -->
                    </div>
                    <!-- /.card -->

                </section>
                <!-- right col -->

            </div>
            <!-- /.row (main row) -->
        </div><!-- /.container-fluid -->
    </section>
    <!-- /.content -->
</div>
<!-- /.content-wrapper -->


{% endblock %}

{% block scripts %}

<!-- Page specific script -->

<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<script>
    var nodes = null;
    var edges = null;
    var network = null;

    function draw() {
        // create people.
        // value corresponds with the age of the person

        nodes = [
            {% for node in nodes %}
                {
                    id: {{ node.pk | safe }},
                    value: {{ node.publications.all.count | safe }},
                    label: "{{ node.short_name | safe }}",
                    image: "https://www.cienciavitae.pt/fotos/publico/{{ node.ciencia_id | safe }}.jpg",
                    title: "{{ node.publications.all.count | safe }} publication{% if node.publications.all.count != 1 %}s{% endif %} (total)",
                },
            {% endfor %}
        ];

        // create connections between people
        // value corresponds with the amount of contact between two people
        edges = [
            {% for edge in edges %}
                {
                    from: {{ edge.0 | safe }},
                    to: {{ edge.1 | safe }},
                    value: {{ edge.2 | safe }},
                    label: "{{ edge.2 | safe }}",
                    title: "{{ edge.2 | safe }} publication{% if edge.2 != 1 %}s{% endif %} together",
                },
            {% endfor %}
        ];

        // Instantiate our network object.
        var container = document.getElementById("mynetwork");
        var data = {
            nodes: nodes,
            edges: edges,
        };
        var options = {
            interaction: { hover: true },
            nodes: {
                shape: "circularImage",

                borderWidth: 2,
                borderWidthSelected: 6,

                color: {
                    border: "rgba(23, 162, 184, 1)",
                    background: "rgba(105, 195, 209, 1)",

                    highlight: {
                        border: "rgba(220, 53, 69, 1)",
                        background: "rgba(220, 53, 69, 1)",
                    },
                    hover: {
                        border: "rgba(220, 53, 69, 1)",
                        background: "rgba(232, 124, 135, 1)",
                    },
                },
                font: { face: "segoe ui", color: "rgba(255, 255, 255, 1)", strokeWidth: 3, strokeColor: "rgba(0, 0, 0, 1)" },
                scaling: {
                    customScalingFunction: function (min, max, total, value) {
                        //console.log(min, max, total, value, value / total)
                        return value / total;
                    },
                    min: 10,
                    max: 100,
                    label: {
                        min: 8,
                        max: 20,
                    },
                },
            },
            edges: {
                color: {
                    color: "rgba(23, 162, 184, 0.7)",
                    highlight: "rgba(220, 53, 69, 0.7)",
                    hover: "rgba(232, 124, 135, 0.7)",
                },
                font: { face: "segoe ui", color: "rgba(255, 255, 255, 1)", strokeWidth: 3, strokeColor: "rgba(0, 0, 0, 1)" },
                scaling: {
                    customScalingFunction: function (min, max, total, value) {
                        //console.log(min, max, total, value, value / total)
                        return value / total;
                    },
                    min: 1,
                    max: 80,
                    label: {
                        min: 8,
                        max: 20,
                    },
                }
            },
            physics: {
                enabled: true,
                barnesHut: {
                    gravitationalConstant: -100,
                    centralGravity: 0,
                    springConstant: 0.001,
                    springLength: 100,
                }
            }
        };
        network = new vis.Network(container, data, options);

        network.selectNodes([{{ author.pk | safe }}]);
        showNode();

        network.on("click", function (params) {
            update_viewer(params);
        });

        network.on("dragStart", function (params) {
            update_viewer(params);
        });

        function showNode() {

            //console.log('\n\n')
            var author = nodes[0];
            for (const node of nodes) {
                //console.log(node.id + '\nvs\n' + network.getSelection().nodes[0]);
                if (node.id == network.getSelection().nodes[0]) {
                    var author = node;
                    break;
                };
            };

            document.getElementById("eventSpanContent").innerText += '\n' + author.id + ' - ' + author.label;

            document.getElementById("eventSpanContent").innerText += '\nConnected to'

            document.getElementById(author.id).hidden = false;

            document.getElementById('viewer').hidden = true;
            document.getElementById('viewer-'+author.id).hidden = false;

            for (const selected_edge of network.getSelection().edges) {

                //document.getElementById("eventSpanContent").innerText += '\n' + selected_edge;

                var connection = edges[0];
                for (const edge of edges) {
                    //console.log(edge.id + '\nvs\n' + selected_edge);
                    if (edge.id === selected_edge) {
                        var connection = edge;
                        break;
                    };
                };

                var colleague_id = -1;
                if (connection.from == author.id) {
                    colleague_id = connection.to
                } else if (connection.to == author.id) {
                    colleague_id = connection.from
                }

                // Look up colleague
                var colleague = nodes[0];
                for (const node of nodes) {
                    //console.log(node.id + '\nvs\n' + colleague_id);
                    if (node.id == colleague_id) {
                        var colleague = node;
                        break;
                    };
                };

                document.getElementById("eventSpanContent").innerText += '\n' + colleague.id + ' - ' + colleague.label;

                //document.getElementById(colleague.id).hidden = false;

            };

        };

        function update_viewer(params) {

            // Clear Viewer
            const viewer_authors = document.getElementsByClassName('viewer_author');
            for (let i = 0; i < viewer_authors.length; i++) {
                viewer_authors[i].hidden = true;
            };

            const viewer_publication_lists = document.getElementsByClassName('viewer_publications');
            for (let i = 0; i < viewer_publication_lists.length; i++) {
                viewer_publication_lists[i].hidden = true;
            };

            const viewer_titles = document.getElementsByClassName('viewer_title');
            for (let i = 0; i < viewer_titles.length; i++) {
                viewer_titles[i].hidden = true;
            };

            document.getElementById('viewer').hidden = false;

            // Override debug div (we dont want to hide this, during debug ofc)
            // document.getElementById("eventSpanContent").hidden = false;

            //document.getElementById("eventSpanContent").innerText = network.getSelection().nodes;
            document.getElementById("eventSpanContent").innerText = '';

            ////////////////////////////////////////////
            //  NODE SELECTED
            ////////////////////////////////////////////
            if (network.getSelection().nodes.length == 1) {
                
                showNode();
            
            ///////////////////////////////////////////////////
            //  EDGE SELECTED
            ///////////////////////////////////////////////////
            } else if (network.getSelection().edges.length == 1) {

                document.getElementById('viewer').hidden = true;

                //console.log('\n\n')
                var connection = edges[0];
                for (const edge of edges) {
                    //console.log(edge.id + '\nvs\n' + network.getSelection().edges[0]);
                    if (edge.id === network.getSelection().edges[0]) {
                        var connection = edge;
                        break;
                    };
                };

                // Look up author 1
                var author_1 = nodes[0];
                for (const node of nodes) {
                    //console.log(node.id + '\nvs\n' + connection.from);
                    if (node.id == connection.from) {
                        var author_1 = node;
                        break;
                    };
                };
                // Look up author 2
                var author_2 = nodes[0];
                for (const node of nodes) {
                    //console.log(node.id + '\nvs\n' + connection.to);
                    if (node.id == connection.to) {
                        var author_2 = node;
                        break;
                    };
                };

                document.getElementById("eventSpanContent").innerText += '\n' + author_1.id + ' - ' + author_1.label + '\nConnected to\n' + author_2.id + ' - ' + author_2.label;

                var key = '' + author_1.id + '-' + author_2.id
                if (author_2.id < author_1.id)
                    var key = '' + author_2.id + '-' + author_1.id
                
                document.getElementById(key).hidden = false;
                    
                document.getElementById('viewer-'+key).hidden = false;

            }

            document.getElementById("eventSpanContent").innerText += '\n \n \n'
        };
    }

    $(function () {
        /* ChartJS
            * -------
            * Here we will create a few charts using ChartJS
            */

        //-------------
        //- BAR CHART -
        //-------------
        var areaChartData = {
            labels: {{ labels_publications|safe }},

            datasets: [
                {
                    label: 'Number of {% if publication_type == 'All' %}Publications{% elif publication_type == 'Other' %}Others{% else %}{{ publication_type }}s{% endif %}',
                    backgroundColor: 'rgba(23, 162, 184, 0.9)',
                    borderColor: 'rgba(23, 162, 184, 0.8)',
                    pointRadius: false,
                    pointColor: '#3b8bba',
                    pointStrokeColor: 'rgba(23, 162, 184, 1)',
                    pointHighlightFill: '#fff',
                    pointHighlightStroke: 'rgba(23, 162, 184, 1)',

                    data: {{ data_publications|safe }}
                },
            ]
        }

        var barChartCanvas = $('#barChart_publications').get(0).getContext('2d')
        var barChartData = $.extend(true, {}, areaChartData)
        var temp0 = areaChartData.datasets[0]
        barChartData.datasets[0] = temp0

        var barChartOptions = {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        precision: 0
                    }
                }]
            },
            responsive: true,
            maintainAspectRatio: false,
            datasetFill: false,
            
        }

        new Chart(barChartCanvas, {
            type: 'bar',
            data: barChartData,
            options: barChartOptions
        })

        //-------------
        //- BAR CHART -
        //-------------
        var areaChartData = {
            labels: {{ labels_projects|safe }},

            datasets: [
                {
                    label: 'Number of projects',
                    backgroundColor: 'rgba(40, 167, 69, 0.9)',
                    borderColor: 'rgba(40, 167, 69, 0.8)',
                    pointRadius: false,
                    pointColor: '#3b8bba',
                    pointStrokeColor: 'rgba(40, 167, 69, 1)',
                    pointHighlightFill: '#fff',
                    pointHighlightStroke: 'rgba(40, 167, 69, 1)',

                    data: {{ data_projects|safe }}
                },
            ]
        }

        var barChartCanvas = $('#barChart_projects').get(0).getContext('2d')
        var barChartData = $.extend(true, {}, areaChartData)
        var temp0 = areaChartData.datasets[0]
        barChartData.datasets[0] = temp0

        var barChartOptions = {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true,
                        precision: 0
                    }
                }]
            },
            responsive: true,
            maintainAspectRatio: false,
            datasetFill: false
        }

        new Chart(barChartCanvas, {
            type: 'bar',
            data: barChartData,
            options: barChartOptions
        })

        

        draw();
    })
</script>

{% endblock %}
